<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Aszendenten-Rechner</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            display: flex;
            height: calc(100vh - 40px);
            overflow: hidden;
        }
        #left-column {
            flex: 1;
            padding-right: 20px;
            max-width: 50%;
            overflow-y: auto;
        }
        #right-column {
            flex: 1;
            padding-left: 20px;
            max-width: 50%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        label {
            display: inline-block;
            width: 150px;
            margin-bottom: 10px;
        }
        input, button {
            margin-bottom: 10px;
        }
        #result, #meaning {
            margin-top: 10px;
        }
        #skyView {
            flex: 2;
        }
        #skyView img {
            max-width: 100%;
            max-height: 40vh;
            border: 1px solid #ccc;
        }
        #trivia, #history {
            flex: 1;
            overflow-y: auto;
            max-height: 25vh;
        }
        h1, h3 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div id="left-column">
        <h1>Aszendenten-Rechner</h1>
        <label for="birthDate">Geburtsdatum:</label>
        <input type="date" id="birthDate"><br>
        <label for="birthTime">Geburtszeit (UTC):</label>
        <input type="time" id="birthTime" placeholder="z.B. 12:00"><br>
        <label for="location">Geburtsort:</label>
        <input type="text" id="location" placeholder="z.B. München"><br>
        <button id="calculateButton">Berechnen</button>
        <p id="coordinates"></p>
        <p id="result"></p>
        <div id="meaning"></div>
    </div>
    <div id="right-column">
        <div id="skyView"></div>
        <div id="trivia"></div>
        <div id="history"></div>
    </div>

    <script>
        window.onload = function() {
            console.log("Seite geladen, DOM bereit.");
            document.getElementById("calculateButton").addEventListener("click", getCoordinatesAndCalculate);
        };

        async function getCoordinatesAndCalculate() {
            console.log("Berechnen geklickt.");
            const birthDateInput = document.getElementById("birthDate");
            const birthTimeInput = document.getElementById("birthTime");
            const locationInput = document.getElementById("location");

            if (!birthDateInput || !birthTimeInput || !locationInput) {
                document.getElementById("result").innerText = "Eingabefelder nicht gefunden!";
                console.error("Eingabefelder fehlen im DOM.");
                return;
            }

            const birthDate = birthDateInput.value;
            const birthTime = birthTimeInput.value;
            const location = locationInput.value;

            if (!birthDate || !birthTime || !location) {
                document.getElementById("result").innerText = "Bitte alle Felder ausfüllen!";
                return;
            }

            console.log("Eingaben:", birthDate, birthTime, location);
            const sunSign = getSunSign(birthDate);

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(location)}&format=json&limit=1`, {
                    headers: { "User-Agent": "Aszendenten-Rechner/1.0" }
                });
                const data = await response.json();

                if (data.length > 0) {
                    const latitude = parseFloat(data[0].lat);
                    const longitude = parseFloat(data[0].lon);
                    document.getElementById("coordinates").innerText = 
                        `Koordinaten: ${latitude}, ${longitude}`;
                    console.log("Koordinaten geladen:", latitude, longitude);

                    calculateAscendant(birthDate, birthTime, latitude, longitude, sunSign);
                    showSkyView(birthDate, birthTime, latitude, longitude);
                } else {
                    document.getElementById("coordinates").innerText = "Ort nicht gefunden!";
                }
            } catch (error) {
                document.getElementById("coordinates").innerText = "Fehler bei der API-Abfrage!";
                console.error("Nominatim Fehler:", error);
            }
        }

        function getSunSign(birthDate) {
            const [year, month, day] = birthDate.split('-').map(Number);
            if ((month == 3 && day >= 21) || (month == 4 && day <= 19)) return "Widder";
            if ((month == 4 && day >= 20) || (month == 5 && day <= 20)) return "Stier";
            if ((month == 5 && day >= 21) || (month == 6 && day <= 20)) return "Zwillinge";
            if ((month == 6 && day >= 21) || (month == 7 && day <= 22)) return "Krebs";
            if ((month == 7 && day >= 23) || (month == 8 && day <= 22)) return "Löwe";
            if ((month == 8 && day >= 23) || (month == 9 && day <= 22)) return "Jungfrau";
            if ((month == 9 && day >= 23) || (month == 10 && day <= 22)) return "Waage";
            if ((month == 10 && day >= 23) || (month == 11 && day <= 21)) return "Skorpion";
            if ((month == 11 && day >= 22) || (month == 12 && day <= 21)) return "Schütze";
            if ((month == 12 && day >= 22) || (month == 1 && day <= 19)) return "Steinbock";
            if ((month == 1 && day >= 20) || (month == 2 && day <= 18)) return "Wassermann";
            if ((month == 2 && day >= 19) || (month == 3 && day <= 20)) return "Fische";
        }

        function calculateSiderealTime(birthDate, birthTime, longitude) {
            const [year, month, day] = birthDate.split('-').map(Number);
            const [hours, minutes] = birthTime.split(':').map(Number);
            const ut = hours + minutes / 60;
            const d = (Date.UTC(year, month - 1, day, hours, minutes) - Date.UTC(2000, 0, 1, 12, 0)) / (1000 * 60 * 60 * 24);
            const gmst = (6.697374558 + 0.06570982441908 * d + 1.00273790935 * ut) % 24;
            const lst = (gmst + longitude / 15) % 24;
            return lst * 15;
        }

        function calculateAscendant(birthDate, birthTime, latitude, longitude, sunSign) {
            const lst = calculateSiderealTime(birthDate, birthTime, longitude);
            const epsilon = 23.44;

            const ascendantRad = Math.atan2(
                -Math.cos(lst * Math.PI / 180),
                Math.sin(lst * Math.PI / 180) * Math.cos(epsilon * Math.PI / 180) +
                Math.tan(latitude * Math.PI / 180) * Math.sin(epsilon * Math.PI / 180)
            );
            let ascendantDeg = ascendantRad * 180 / Math.PI;
            if (ascendantDeg < 0) ascendantDeg += 360;

            const signs = ["Widder", "Stier", "Zwillinge", "Krebs", "Löwe", "Jungfrau",
                           "Waage", "Skorpion", "Schütze", "Steinbock", "Wassermann", "Fische"];
            const signIndex = Math.floor(ascendantDeg / 30);
            const ascendantSign = signs[signIndex];

            document.getElementById("result").innerText = 
                `Dein Sternzeichen ist: ${sunSign}\nDein Aszendent ist: ${ascendantSign} (Winkel: ${ascendantDeg.toFixed(2)}°)`;
            showCombinedMeaning(sunSign, ascendantSign);
        }

        function showCombinedMeaning(sunSign, ascendantSign) {
            const combinedMeanings = {
                "Widder": `Als ${sunSign} mit Widder-Aszendent kombinierst du deine innere Natur mit einer dynamischen, mutigen Außenwirkung. Du bist ein echter Anführer.`,
                "Stier": `Mit ${sunSign} und einem Stier-Aszendenten verbindest du deine Persönlichkeit mit Ruhe und Ausdauer. Du strahlst Stabilität aus.`,
                "Zwillinge": `${sunSign} mit Zwillinge-Aszendent macht dich noch kommunikativer und vielseitiger. Du wirkst lebhaft und kontaktfreudig.`,
                "Krebs": `Als ${sunSign} mit Krebs-Aszendent fügst du deiner Natur eine sanfte, emotionale Schicht hinzu. Du wirkst einfühlsam und schützend.`,
                "Löwe": `Mit ${sunSign} und Löwe-Aszendent strahlst du Selbstbewusstsein und Wärme aus. Du ziehst andere magisch an.`,
                "Jungfrau": `${sunSign} mit Jungfrau-Aszendent macht dich präzise und hilfsbereit. Du wirkst organisiert und verlässlich.`,
                "Waage": `Als ${sunSign} mit Waage-Aszendent bringst du Harmonie und Charme in dein Auftreten. Du bist ein Friedensstifter.`,
                "Skorpion": `Mit ${sunSign} und Skorpion-Aszendent wirkst du tiefgründig und magnetisch. Deine Präsenz ist intensiv.`,
                "Schütze": `${sunSign} mit Schütze-Aszendent verstärkt deine Abenteuerlust und deinen Optimismus. Du wirkst inspirierend.`,
                "Steinbock": `Als ${sunSign} mit Steinbock-Aszendent kombinierst du deine Essenz mit Zielstrebigkeit. Du wirkst seriös und fokussiert.`,
                "Wassermann": `Mit ${sunSign} und Wassermann-Aszendent bringst du Originalität und Freiheitsliebe nach außen. Du wirkst einzigartig.`,
                "Fische": `${sunSign} mit Fische-Aszendent fügt deiner Persönlichkeit eine verträumte, intuitive Note hinzu. Du wirkst sanft und tiefgründig.`
            };

            document.getElementById("meaning").innerHTML = 
                `<h3>Deine Kombination:</h3><p>${combinedMeanings[ascendantSign]}</p>`;
        }

        async function showSkyView(birthDate, birthTime, latitude, longitude) {
            const lst = calculateSiderealTime(birthDate, birthTime, longitude);
            const ra = lst / 15;
            const dec = latitude;

            const skyViewUrl = `https://skyview.gsfc.nasa.gov/cgi-bin/images?position=${ra},${dec}&survey=DSS&coordinates=Equatorial&pixels=500&size=0.5&return=PNG`;
            document.getElementById("skyView").innerHTML = 
                `<h3>Himmelskarte:</h3><img src="${skyViewUrl}" alt="Himmelsansicht">`;
        }
    </script>
</body>
</html>
